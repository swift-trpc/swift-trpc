//
//  TrpcBatchRequest.swift
//  swift-trpc
//
//  Created by Artem Tarasenko on 17.11.2024.
//

import Foundation

internal struct TrpcBatchRequest: HttpClientRequestProtocol {
    var path: String
    var method: HttpMethod
    var headers: [String: String]
    var query: [String: String]
    var body: Data?

    init(requests: [any TrpcRequestProtocol], trpcClient: any TrpcClientProtocol) throws {
        if requests.count == 0 {
            throw TrpcError.batchRequestEmpty
        }

        let requestType = requests[0].type

        let requestTypesDiffer = requests.contains { request in
            request.type != requestType
        }

        if requestTypesDiffer {
            throw TrpcError.batchRequestTypesDiffer
        }

        self.path = requests.map({ $0.path }).joined(separator: ",")
        self.headers = requests.reduce(trpcClient.baseHeaders) { partialResult, request in
            return partialResult.merged(with: request.headers)
        }

        var encodedInputs: [String: Any] = [:]

        for (requestIndex, request) in requests.enumerated() {
            if request.hasInputData, let inputData = try request.serializeInput() {
                let decoded = try JSONSerialization.jsonObject(with: inputData)
                encodedInputs[String(requestIndex)] = decoded
            }
        }

        let encodedInputsData = try JSONSerialization.data(withJSONObject: encodedInputs)

        self.query = [:]

        if requestType == .mutation {
            self.method = .post
            self.body = encodedInputsData
        } else {
            self.method = .get
            self.body = nil
            self.query["input"] = String(data: encodedInputsData, encoding: .utf8)
        }

        self.query["batch"] = "1"
    }
}
